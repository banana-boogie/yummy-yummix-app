#!/bin/sh

# Exit on any error
set -e

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files, skipping pre-commit checks"
  exit 0
fi

# ============================================================
# YYX-APP: ESLint via lint-staged
# ============================================================
YYX_APP_FILES=$(echo "$STAGED_FILES" | grep "^yyx-app/" || true)
if [ -n "$YYX_APP_FILES" ]; then
  echo "ğŸ” Running lint-staged for yyx-app..."
  cd yyx-app && npx lint-staged
  cd ..
fi

# ============================================================
# YYX-SERVER: Deno format and lint
# ============================================================
YYX_SERVER_FILES=$(echo "$STAGED_FILES" | grep "^yyx-server/supabase/functions/" || true)
if [ -n "$YYX_SERVER_FILES" ]; then
  echo "ğŸ” Checking deno fmt for yyx-server..."
  cd yyx-server

  # First check if formatting is needed
  if ! deno task fmt:check > /dev/null 2>&1; then
    echo "âš ï¸  Formatting issues detected. Auto-formatting..."
    deno task fmt

    # Re-add the formatted files
    cd ..
    echo "$YYX_SERVER_FILES" | while read -r file; do
      if [ -f "$file" ]; then
        git add "$file"
      fi
    done
    cd yyx-server

    echo "âœ… Files formatted and re-staged"
  else
    echo "âœ… Formatting check passed"
  fi

  echo "ğŸ” Running deno lint for yyx-server..."
  deno lint supabase/functions/
  echo "âœ… Lint check passed"

  cd ..
fi

echo ""
echo "âœ… All pre-commit checks passed!"
