#!/bin/sh

# Exit on any error
set -e

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files, skipping pre-commit checks"
  exit 0
fi

# ============================================================
# YYX-APP: ESLint via lint-staged
# ============================================================
YYX_APP_FILES=$(echo "$STAGED_FILES" | grep "^yyx-app/" || true)
if [ -n "$YYX_APP_FILES" ]; then
  echo "üîç Running lint-staged for yyx-app..."
  cd yyx-app && npx lint-staged
  cd ..
fi

# ============================================================
# YYX-SERVER: Deno format and lint
# ============================================================
YYX_SERVER_FILES=$(echo "$STAGED_FILES" | grep "^yyx-server/supabase/functions/" || true)
if [ -n "$YYX_SERVER_FILES" ]; then
  echo "üîç Checking deno fmt for yyx-server..."
  cd yyx-server

  # First check if formatting is needed
  if ! deno task fmt:check > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  Formatting issues detected. Auto-formatting..."
    deno task fmt

    # Re-add the formatted files
    cd ..
    echo "$YYX_SERVER_FILES" | while read -r file; do
      if [ -f "$file" ]; then
        git add "$file"
      fi
    done
    cd yyx-server

    echo "‚úÖ Files formatted and re-staged"
  else
    echo "‚úÖ Formatting check passed"
  fi

  echo "üîç Running deno lint for yyx-server..."
  # Only lint staged .ts files, using deno.json config for rule exclusions
  LINT_FILES=$(echo "$YYX_SERVER_FILES" | grep '\.ts$' | sed 's|^yyx-server/||' || true)
  if [ -n "$LINT_FILES" ]; then
    echo "$LINT_FILES" | xargs deno lint --config deno.json
  fi
  echo "‚úÖ Lint check passed"

  cd ..
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
